<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Details</title>
    <link rel="stylesheet" href="/styles.css" />
</head>
<body>

<div class="d-page">
    <button id="returnbtn"> < Go Back</button>
<h2 id="doc_title" class="title-field"></h2>
<div class="details">
    <div class="static">
        <h3>Gemini AI Summary</h3>
        <p id="ai_summary" class="field">insert gemini summary here</p>
    </div>

</div>
    <br>
    <div id="comment_section">
        <h3>Add a comment</h3>
        <div>
            <label>
                Author:
                <input type="text" id="author" required />
            </label>

            <label>
                Comment:
                <textarea id="comment_content" required></textarea>
            </label>

            <button id="addcomment">Add Comment</button>
            <br>
            <div id="commentstatus"></div>
        </form>

        <h3>Comments</h3>
        <div class="listcont">
            <ul id="comlist">PLACEHOLDER TEXT</ul>
        </div>

    </div>
</div>
<script>
    async function loadDetail() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        if (!id) {
            document.getElementById('title').textContent = 'No ID provided';
            return;
        }
        document.getElementById('returnbtn').addEventListener('click',  () => {
            window.location.href = `index.html`;
        })
        try {
            const r = await fetch(`/api/docs/${id}`);
            if (!r.ok) {
                document.getElementById('doc_title').textContent = `HTTP ${r.status}`;
                return;
            }
            const item = await r.json();
            document.getElementById('doc_title').textContent = `${item.id}: ${item.title}`;

            //set AI summary
            var docstring = item.content;
            document.getElementById('ai_summary').innerHTML = docstring.replace(/\n/g, "<br><br>")
            document.getElementById('comlist').innerHTML = "Nothing posted yet."

            loadComments(id);
            document.getElementById('addcomment').addEventListener('click', () => sendComment(id));

        } catch (e) {
            document.getElementById('doc_title').textContent = `Error: ${e}`;
        }
    }

    async function sendComment(id)
    {
        try {
            const data = new FormData();
            data.append("doc_id",id);
            data.append("author",document.getElementById('author').value);
            data.append("content",document.getElementById('comment_content').value)

            const r = await fetch('api/comments', {
                method: 'POST',
                body: data
            });
            document.getElementById('commentstatus').textContent=await r.text();
            loadComments(id);
        }
        catch (e) {
            document.getElementById('commentstatus').textContent='There was an error posting your comment.';
        }
    }

    async function loadComments(id)
    {
        try {
            const ul = document.getElementById('comlist');
            const r = await fetch(`/api/comments/${id}`);

            if (!r.ok) {
                return;
            }
            const data = await r.json();
            ul.innerHTML = '';
            (Array.isArray(data) ? data : []).forEach(item => {
                const li = document.createElement('li');
                var li_header = document.createElement('h4');
                li_header.textContent=`${item.author} wrote:`;
                var li_content = document.createElement('div');
                li_content.textContent=item.content;
                li.classList.add('com-list');
                li.appendChild(li_header);
                li.appendChild(li_content);
                ul.appendChild(li);
            });
        }
        catch (e)
        {
            ocument.getElementById('comlist').innerHTML = 'An error occured while loading comments.';
        }
    }

    window.addEventListener('DOMContentLoaded', loadDetail);
</script>

</body>
</html>